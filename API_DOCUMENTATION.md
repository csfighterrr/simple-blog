# Simple Blog API Documentation

This document describes the Next.js API endpoints for the Simple Blog application with admin role-based access control.

## Base URL
```
http://localhost:3000/api
```

## Authentication & Authorization
- Most endpoints that modify data require authentication
- POST /api/posts requires **ADMIN ROLE** authentication
- Authentication is handled by Supabase Auth with JWT tokens
- Admin access uses Bearer token in Authorization header

## User Roles
- **user**: Default role for regular users
- **admin**: Special role required for creating posts

## API Endpoints

### Posts API

#### GET /api/posts
Fetch all posts with pagination and filtering options.

**Authentication**: None required

**Query Parameters:**
- `page` (number, default: 1) - Page number
- `limit` (number, default: 10) - Posts per page
- `published` (boolean) - Filter by published status
- `author` (string) - Filter by author ID

**Example Request:**
```javascript
const response = await fetch('/api/posts?page=1&limit=5&published=true')
const data = await response.json()
```

**Response:**
```json
{
  "posts": [
    {
      "id": "uuid",
      "title": "Post Title",
      "content": "Post content...",
      "published": true,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T00:00:00Z",
      "author_id": "uuid",
      "image_url": null,
      "profiles": {
        "id": "uuid",
        "display_name": "John Doe"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 25,
    "hasMore": true
  }
}
```

#### POST /api/posts ⚠️ **ADMIN ONLY**
Create a new post. **REQUIRES ADMIN ROLE**.

**Authentication**: Required (Admin Bearer Token)

**Headers:**
```
Content-Type: application/json
Authorization: Bearer <Admin_JWT_Token>
```

**Request Body:**
```json
{
  "title": "My New Post",
  "content": "This is the content of my post...",
  "published": false,
  "image_url": "https://example.com/image.jpg"
}
```

**Auto-Generated Fields:**
- `id` - UUID automatically generated by database
- `created_at` - Timestamp automatically generated
- `author_id` - Automatically set to admin user ID

**Success Response (201 Created):**
```json
{
  "message": "Post created successfully",
  "post": {
    "id": "new-post-uuid",
    "title": "My New Post",
    "content": "This is the content...",
    "published": false,
    "author_id": "admin-user-uuid",
    "created_at": "2024-01-01T00:00:00Z",
    "image_url": "https://example.com/image.jpg",
    "author": {
      "id": "admin-user-uuid",
      "display_name": "Admin User",
      "role": "admin"
    }
  }
}
```

**Error Responses:**
- `400` - Missing required fields (title, content)
- `401` - Invalid/missing Bearer token
- `403` - User is not admin
- `500` - Server error

### Individual Post API

#### GET /api/posts/[id]
Fetch a specific post by ID.

**Authentication**: None required

**Example Request:**
```javascript
const response = await fetch('/api/posts/123e4567-e89b-12d3-a456-426614174000')
const data = await response.json()
```

#### PUT /api/posts/[id]
Update a specific post.

**Authentication**: Recommended for ownership verification

**Request Body:**
```json
{
  "title": "Updated Title",
  "content": "Updated content...",
  "published": true
}
```

#### DELETE /api/posts/[id]
Delete a specific post.

**Authentication**: Recommended for ownership verification

**Response:**
```json
{
  "message": "Post deleted successfully",
  "deletedPost": {
    "id": "uuid",
    "title": "Deleted Post Title"
  }
}
```

### Authentication API

#### POST /api/auth/login
User login.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  },
  "session": {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token"
  },
  "message": "Login successful"
}
```

#### POST /api/auth/register
User registration. **Creates user with default 'user' role**.

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "password123",
  "display_name": "John Doe"
}
```

**Note**: New users are created with `role: 'user'` by default. Admin access must be granted separately.

#### POST /api/auth/logout
User logout.

**Response:**
```json
{
  "message": "Logout successful"
}
```

### User Profile API

#### GET /api/users/[id]
Get user profile by ID.

**Response:**
```json
{
  "profile": {
    "id": "uuid",
    "display_name": "John Doe",
    "avatar_url": "https://example.com/avatar.jpg",
    "bio": "User bio...",
    "website": "https://johndoe.com",
    "role": "user",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z",
    "post_count": 15
  }
}
```

#### PUT /api/users/[id]
Update user profile.

**Request Body:**
```json
{
  "display_name": "Updated Name",
  "bio": "Updated bio...",
  "website": "https://newwebsite.com"
}
```

**Note**: Role cannot be updated via API for security reasons.

### Statistics API

#### GET /api/stats
Get blog statistics.

**Response:**
```json
{
  "stats": {
    "totalPosts": 100,
    "publishedPosts": 75,
    "draftPosts": 25,
    "totalUsers": 50
  },
  "recentPosts": [
    {
      "id": "uuid",
      "title": "Recent Post",
      "created_at": "2024-01-01T00:00:00Z",
      "published": true,
      "profiles": {
        "id": "uuid",
        "display_name": "Author Name"
      }
    }
  ]
}
```

## Admin Management

### Making a User Admin

#### Database Function (Recommended)
```sql
-- Use the helper function
SELECT make_user_admin('user-uuid-here');
```

#### Manual SQL Update
```sql
UPDATE public.profiles 
SET role = 'admin' 
WHERE id = 'user-uuid-here';
```

#### Verify Admin Users
```sql
SELECT id, display_name, role 
FROM public.profiles 
WHERE role = 'admin';
```

### Admin Authentication Flow
1. User logs in normally via `/api/auth/login`
2. Receives JWT token in response
3. Uses Bearer token in Authorization header for admin endpoints
4. API verifies token and checks user role
5. Only allows access if role is 'admin'

## Usage Examples

### Creating a Post (Admin Only)
```javascript
const createPost = async (postData, adminToken) => {
  const response = await fetch('/api/posts', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${adminToken}`
    },
    body: JSON.stringify(postData),
  })

  if (!response.ok) {
    const error = await response.json()
    if (response.status === 403) {
      throw new Error('Admin access required')
    } else if (response.status === 401) {
      throw new Error('Invalid or expired token')
    }
    throw new Error(error.error || 'Failed to create post')
  }

  return response.json()
}

// Usage
try {
  const newPost = await createPost({
    title: 'My Blog Post',
    content: 'This is my blog post content...',
    published: true
  }, 'admin-jwt-token-here')
  console.log('Post created:', newPost)
} catch (error) {
  console.error('Error:', error.message)
}
```

### Fetching Posts with Pagination
```javascript
const fetchPosts = async (page = 1, limit = 10) => {
  const response = await fetch(`/api/posts?page=${page}&limit=${limit}&published=true`)
  
  if (!response.ok) {
    throw new Error('Failed to fetch posts')
  }
  
  return response.json()
}

// Usage
const { posts, pagination } = await fetchPosts(1, 5)
console.log('Posts:', posts)
console.log('Has more:', pagination.hasMore)
```

### Admin Login Flow
```javascript
const adminLogin = async (email, password) => {
  // Step 1: Login normally
  const loginResponse = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, password }),
  })

  if (!loginResponse.ok) {
    throw new Error('Login failed')
  }

  const { user, session } = await loginResponse.json()
  
  // Step 2: Verify admin role
  const profileResponse = await fetch(`/api/users/${user.id}`)
  const { profile } = await profileResponse.json()
  
  if (profile.role !== 'admin') {
    throw new Error('Admin access required')
  }
  
  return {
    user,
    token: session.access_token,
    isAdmin: true
  }
}

// Usage
try {
  const adminAuth = await adminLogin('admin@example.com', 'password')
  console.log('Admin logged in:', adminAuth.user)
  
  // Now can create posts
  const newPost = await createPost({
    title: 'Admin Post',
    content: 'Content from admin...',
    published: true
  }, adminAuth.token)
} catch (error) {
  console.error('Admin login error:', error.message)
}
```

## Error Handling
All API endpoints return consistent error responses:

```json
{
  "error": "Error message",
  "details": "Detailed error information (optional)"
}
```

### Common HTTP Status Codes:
- `200` - Success
- `201` - Created successfully  
- `400` - Bad request (validation error)
- `401` - Unauthorized (invalid/missing token)
- `403` - Forbidden (insufficient permissions)
- `404` - Not found
- `409` - Conflict (e.g., duplicate data)
- `500` - Internal server error

### Admin-Specific Error Responses:
- `401` - "Authorization header with Bearer token is required"
- `401` - "Invalid or expired token"
- `403` - "Admin access required"
- `404` - "User profile not found"

## Security Features

1. **Role-Based Access Control (RBAC)** - Admin role required for post creation
2. **JWT Token Authentication** - Secure token-based auth
3. **Guard Clauses** - Multi-layer security checks
4. **Input Validation** - Server-side validation for all inputs
5. **SQL Injection Protection** - Parameterized queries via Supabase
6. **CORS Protection** - Configured for specific origins
7. **Rate Limiting** - Can be added via middleware

## Testing the API

### cURL Examples:

```bash
# Get all posts (public)
curl -X GET "http://localhost:3000/api/posts?page=1&limit=5"

# Create a new post (admin only)
curl -X POST "http://localhost:3000/api/posts" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-admin-jwt-token" \
  -d '{
    "title": "Test Post",
    "content": "This is a test post",
    "published": true
  }'

# Login to get token
curl -X POST "http://localhost:3000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "password123"
  }'

# Get blog statistics
curl -X GET "http://localhost:3000/api/stats"
```

## Database Schema Updates

The API now includes role-based access with the following schema changes:

```sql
-- Add role column to profiles table
ALTER TABLE public.profiles 
ADD COLUMN role text DEFAULT 'user' CHECK (role IN ('user', 'admin'));

-- Create index for performance
CREATE INDEX idx_profiles_role ON public.profiles(role);
```

This API provides a comprehensive, secure foundation for your Simple Blog application with proper admin access control and full CRUD operations.

### Individual Post API

#### GET /api/posts/[id]
Fetch a specific post by ID.

**Example Request:**
```javascript
const response = await fetch('/api/posts/123e4567-e89b-12d3-a456-426614174000')
const data = await response.json()
```

#### PUT /api/posts/[id]
Update a specific post.

**Request Body:**
```json
{
  "title": "Updated Title",
  "content": "Updated content...",
  "published": true
}
```

#### DELETE /api/posts/[id]
Delete a specific post.

**Response:**
```json
{
  "message": "Post deleted successfully",
  "deletedPost": {
    "id": "uuid",
    "title": "Deleted Post Title"
  }
}
```

### Authentication API

#### POST /api/auth/login
User login.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  },
  "session": {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token"
  },
  "message": "Login successful"
}
```

#### POST /api/auth/register
User registration.

**Request Body:**
```json
{
  "email": "newuser@example.com",
  "password": "password123",
  "display_name": "John Doe"
}
```

#### POST /api/auth/logout
User logout.

**Response:**
```json
{
  "message": "Logout successful"
}
```

### User Profile API

#### GET /api/users/[id]
Get user profile by ID.

**Response:**
```json
{
  "profile": {
    "id": "uuid",
    "display_name": "John Doe",
    "avatar_url": "https://example.com/avatar.jpg",
    "bio": "User bio...",
    "website": "https://johndoe.com",
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z",
    "post_count": 15
  }
}
```

#### PUT /api/users/[id]
Update user profile.

**Request Body:**
```json
{
  "display_name": "Updated Name",
  "bio": "Updated bio...",
  "website": "https://newwebsite.com"
}
```

### Statistics API

#### GET /api/stats
Get blog statistics.

**Response:**
```json
{
  "stats": {
    "totalPosts": 100,
    "publishedPosts": 75,
    "draftPosts": 25,
    "totalUsers": 50
  },
  "recentPosts": [
    {
      "id": "uuid",
      "title": "Recent Post",
      "created_at": "2024-01-01T00:00:00Z",
      "published": true,
      "profiles": {
        "id": "uuid",
        "display_name": "Author Name"
      }
    }
  ]
}
```

## Usage Examples

### Creating a Post
```javascript
const createPost = async (postData) => {
  const response = await fetch('/api/posts', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(postData),
  })

  if (!response.ok) {
    throw new Error('Failed to create post')
  }

  return response.json()
}

// Usage
try {
  const newPost = await createPost({
    title: 'My Blog Post',
    content: 'This is my blog post content...',
    published: true,
    author_id: 'user-uuid'
  })
  console.log('Post created:', newPost)
} catch (error) {
  console.error('Error:', error)
}
```

### Fetching Posts with Pagination
```javascript
const fetchPosts = async (page = 1, limit = 10) => {
  const response = await fetch(`/api/posts?page=${page}&limit=${limit}&published=true`)
  
  if (!response.ok) {
    throw new Error('Failed to fetch posts')
  }
  
  return response.json()
}

// Usage
const { posts, pagination } = await fetchPosts(1, 5)
console.log('Posts:', posts)
console.log('Has more:', pagination.hasMore)
```

### User Authentication
```javascript
const login = async (email, password) => {
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, password }),
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || 'Login failed')
  }

  return response.json()
}

// Usage
try {
  const { user, session } = await login('user@example.com', 'password123')
  console.log('Logged in:', user)
  // Store session token for future requests
} catch (error) {
  console.error('Login error:', error.message)
}
```

### Error Handling
All API endpoints return consistent error responses:

```json
{
  "error": "Error message",
  "details": "Detailed error information (optional)"
}
```

Common HTTP status codes:
- `200` - Success
- `201` - Created successfully
- `400` - Bad request (validation error)
- `401` - Unauthorized
- `404` - Not found
- `409` - Conflict (e.g., duplicate data)
- `500` - Internal server error

## Testing the API

You can test the API endpoints using tools like:
- **Thunder Client** (VS Code extension)
- **Postman**
- **curl** commands
- **JavaScript fetch** in browser console

### Example curl commands:

```bash
# Get all posts
curl -X GET "http://localhost:3000/api/posts?page=1&limit=5"

# Create a new post
curl -X POST "http://localhost:3000/api/posts" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Post",
    "content": "This is a test post",
    "published": true,
    "author_id": "your-user-uuid"
  }'

# Get blog statistics
curl -X GET "http://localhost:3000/api/stats"
```

This API provides a solid foundation for your Simple Blog application with full CRUD operations, authentication, and useful utility endpoints.